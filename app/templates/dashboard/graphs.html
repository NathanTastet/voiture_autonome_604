{% set no_footer = true %}
{% extends "layout.html" %}
{% block page_title %}Robot IUT Lyon 1 – Supervision{% endblock %}

{% block head %}
  <style>
    /* Adapté pour un layout fluide avec tabs */
    .dash-canvas { height: 400px; width: 100%; }
    .gauge-wrapper { max-width: 340px; margin: auto; }
    #floating-info-card {
      position: fixed;
      bottom: 20px;
      left: 20px;
      z-index: 1050;
      width: 340px;
    }
    @media (max-width: 767px) {
      #floating-info-card {
        display: none;
      }
    }
  </style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <!-- Onglets principaux -->
  <ul class="nav nav-pills mb-3" id="dashTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-nav" data-bs-toggle="pill" data-bs-target="#pane-nav" type="button" role="tab">Navigation</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-veh" data-bs-toggle="pill" data-bs-target="#pane-veh" type="button" role="tab">État du véhicule</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-ctl" data-bs-toggle="pill" data-bs-target="#pane-ctl" type="button" role="tab">Contrôle</button>
    </li>
  </ul>

  <div class="tab-content" id="dashTabsContent">
    <!-- NAVIGATION & PERCEPTION -->
    <div class="tab-pane fade show active" id="pane-nav" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-8">
          <div class="card h-100">
            <div class="card-body">
              <h4 class="card-title">Trajectoire</h4>
              <canvas id="vehicleTrackCanvas" class="dash-canvas"></canvas>
              <div class="row text-center pt-2">
                <div class="col">
                  <small>Vitesse</small><br><span id="current-speed" class="fw-bold">--</span> km/h
                </div>
                <div class="col">
                  <small>Distance</small><br><span id="distance-traveled" class="fw-bold">--</span> m
                </div>
                <div class="col">
                  <small>Direction</small><br><span id="vehicle-direction" class="fw-bold">--</span>
                </div>
                <div class="col">
                  <small>Tours</small><br><span id="lap-count" class="fw-bold">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body d-flex flex-column">
              <h4 class="card-title">Flux caméra</h4>
              <img id="cameraStream" src="https://via.placeholder.com/800x600?text=Caméra" alt="Flux caméra" class="img-fluid flex-grow-1 rounded">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÉTAT DU VÉHICULE -->
    <div class="tab-pane fade" id="pane-veh" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-xl-4">
          <div class="card h-100">
            <div class="card-body d-flex flex-column align-items-center">
              <h4 class="card-title">Batterie</h4>
              <div class="gauge-wrapper">
                <canvas id="batteryGauge"></canvas>
              </div>
              <p class="mt-3">Niveau : <span id="battery-level" class="fw-bold">--</span>%</p>
            </div>
          </div>
        </div>
        <div class="col-12 col-xl-8">
          <div class="card h-100">
            <div class="card-body">
              <h4 class="card-title">Historique Batterie</h4>
              <canvas id="batteryHistory" class="dash-canvas"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Puissance moteur</h5>
              <span id="motor-power">--</span> W
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Consommation énergétique</h5>
              <span id="energy-consumption">--</span> Wh
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-4">
          <div class="card h-100">
            <div class="card-body">
              <h5 class="card-title">Télémétrie</h5>
              LiDAR/Sonar : <span id="telemetry">--</span> cm<br>
              Encodeurs : <span id="encoder">--</span> tours/min
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CONTRÔLE & ACTIONS -->
    <div class="tab-pane fade" id="pane-ctl" role="tabpanel">
      <div class="row g-3">
        <div class="col-12 col-lg-6 col-xl-4">
          <div class="card h-100">
            <div class="card-body">
              <h4 class="card-title">Pilotage</h4>
              <button id="start-stop-btn" class="btn btn-primary btn-lg w-100 mb-3">
                <i class="bi bi-play-fill"></i> Démarrer
              </button>
              <label for="mode-selector" class="form-label">Mode :</label>
              <select id="mode-selector" class="form-select mb-3">
                <option value="manuel">Manuel</option>
                <option value="auto">Automatique</option>
                <option value="simu" selected>Simulation</option>
              </select>
              <button id="reset-sensors-btn" class="btn btn-warning w-100">
                <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser capteurs
              </button>
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-6 col-xl-8">
          <div class="card h-100">
            <div class="card-body">
              <h4 class="card-title">Journal d’activité</h4>
              <div id="activity-log" style="max-height: 260px; overflow-y: auto;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Panneau flottant (desktop) -->
<div id="floating-info-card" class="card shadow-sm">
  <div class="card-body d-flex justify-content-between align-items-center small">
    <span>
      <span id="connection-mode">--</span> |
      IP : <span id="vehicle-ip-info">{{ config_connection.ip }}</span> |
      Ping : <span id="floating-ping">--</span> ms
    </span>
    <button id="toggle-floating-btn" class="btn btn-outline-secondary btn-sm">
      <i class="bi bi-arrows-angle-contract"></i>
    </button>
  </div>
</div>
{% endblock %}

{% block js %}
  <script src="{{ url_for('static', filename='build/dash-common.bundle.js') }}"></script>
  <script src="{{ url_for('static', filename='build/dash-graphs.bundle.js') }}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      window.startPingLoop();
      window.setupStartStopControl();  // ← obligatoire !
    });
  </script>
{% endblock %}
