{% set no_footer = true %}

{% extends "layout.html" %}

{% block page_title %}Robot IUT Lyon 1 - Dashboard{% endblock %}

{% block head %}
<style>
  /* Chaque carte occupe 100% de la hauteur de la fenêtre */
  .carousel-item {
    height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.5s ease-in-out;
  }
  .card.full-card {
    width: 100%;
    height: 90%;
    box-shadow: 0 0 10px rgba(0,0,0,0.15);
  }
  /* Style du panneau flottant d'information */
  #floating-info-card {
    position: fixed;
    bottom: 20px;
    left: 20px;
    z-index: 1000;
  }
  @media (max-width: 767px) {
    #floating-info-card {
      display: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid p-0">
  <div id="dashboardCarousel" class="carousel slide carousel-fade" data-bs-ride="carousel" data-bs-touch="true">
    <div class="carousel-inner">
      <!-- Carte 1 : Navigation / Perception -->
      <div class="carousel-item active">
        <div class="card full-card">
          <div class="card-body">
            <h3>Navigation & Perception</h3>
            <div class="row">
              <div class="col-md-6 mb-3">
                <canvas id="vehicleTrackCanvas" style="width:100%; height:400px;"></canvas>
                <p class="mt-2">Trajectoire en temps réel</p>
              </div>
              <div class="col-md-6">
                <div class="camera-stream">
                  <img id="cameraStream" src="https://via.placeholder.com/800x600?text=Caméra" alt="Flux caméra" class="img-fluid">
                  <p class="mt-2">Flux caméra</p>
                </div>
              </div>
            </div>
            <div>
              <p>Cap / Direction: <span id="vehicle-direction">--</span></p>
              <p>Distance parcourue: <span id="distance-traveled">--</span> m</p>
              <p>Dernière position GPS: <span id="last-gps">--</span></p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Carte 2 : État du Véhicule -->
      <div class="carousel-item">
        <div class="card full-card">
          <div class="card-body">
            <h3>État du Véhicule</h3>
            <div class="row">
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h5>Batterie & Vitesse</h5>
                    <p>Batterie : <span id="battery-level">--</span>%</p>
                    <p>Vitesse : <span id="current-speed">--</span> km/h</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h5>Télémétrie</h5>
                    <p>Télémétrie (LiDAR/Sonar) : <span id="telemetry">--</span> cm</p>
                    <p>Encodeurs : <span id="encoder">--</span> tours/min</p>
                  </div>
                </div>
              </div>
              <div class="col-md-4 mb-3">
                <div class="card">
                  <div class="card-body">
                    <h5>État des Capteurs</h5>
                    <p>Capteurs: <span id="sensor-status">OK</span></p>
                    <hr>
                    <h6>Alertes</h6>
                    <ul id="alerts-log" style="max-height: 150px; overflow-y: auto; list-style-type: none; padding-left: 0;">
                      <li>Aucune alerte</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Carte 3 : Contrôle & Actions -->
      <div class="carousel-item">
        <div class="card full-card">
          <div class="card-body">
            <h3>Contrôle & Actions</h3>
            <div class="mb-3">
              <button id="start-stop-btn" class="btn btn-primary btn-lg me-2">
                <i class="bi bi-play-fill"></i> Démarrer
              </button>
            </div>
            <div class="mb-3">
              <label for="mode-selector" class="form-label">Sélectionner le mode de pilotage :</label>
              <select id="mode-selector" class="form-select">
                <option value="manuel">Manuel</option>
                <option value="auto">Automatique</option>
                <option value="simu" selected>Simulation</option>
              </select>
            </div>
            <div class="mb-3">
              <button id="reset-sensors-btn" class="btn btn-warning">
                <i class="bi bi-arrow-counterclockwise"></i> Réinitialiser les capteurs
              </button>
            </div>
            <div>
              <h5>Journal d’Activité</h5>
              <div id="activity-log" style="max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f8f9fa;">
                <p>Aucune action pour le moment.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      
    </div>
    <!-- Boutons de navigation du carousel -->
    <button class="carousel-control-prev" type="button" data-bs-target="#dashboardCarousel" data-bs-slide="prev">
      <span class="carousel-control-prev-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Précédent</span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#dashboardCarousel" data-bs-slide="next">
      <span class="carousel-control-next-icon" aria-hidden="true"></span>
      <span class="visually-hidden">Suivant</span>
    </button>
  </div>
</div>

<!-- Panneau flottant d'information (version desktop) -->
<div id="floating-info-card" class="card">
  <div class="card-body d-flex flex-wrap align-items-center justify-content-between">
    <div class="d-flex align-items-center" style="font-size: 0.8rem;">
      <span id="connection-mode">--</span>&nbsp;|&nbsp;
      IP: <span id="vehicle-ip-info">{{ config_connection.ip }}</span>&nbsp;|&nbsp;
      Ping: <span id="floating-ping">--</span> ms
    </div>
    <div class="d-flex align-items-center">
      <button id="toggle-floating-btn" class="btn btn-outline-secondary btn-sm me-2" title="Réduire/Masquer le panneau">
        <i class="bi bi-arrows-angle-contract"></i>
      </button>
      <button id="start-stop-floating-btn" class="btn btn-primary btn-sm">
        <i class="bi bi-play-fill"></i>
      </button>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<!-- Intégration de Chart.js pour la trajectoire -->
<script src="{{ url_for('static', filename='build/dashboard.bundle.js') }}"></script>
<script>
  // Initialisation du graphique de trajectoire sur la carte Navigation & Perception
  document.addEventListener("DOMContentLoaded", function() {
    const ctx = document.getElementById('vehicleTrackCanvas').getContext('2d');
    window.vehicleTrackChart = new Chart(ctx, {
      type: 'line',
      data: {
          labels: [],
          datasets: [{
              label: 'Trajectoire',
              data: [],
              fill: false,
              tension: 0.1
          }]
      },
      options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
              x: { display: true },
              y: { display: true }
          }
      }
    });
    
    // Gestion du panneau flottant rétractable
    const floatingInfo = document.getElementById("floating-info-card");
    const toggleBtn = document.getElementById("toggle-floating-btn");
    toggleBtn.addEventListener("click", function(){
      if(floatingInfo.style.display === "none"){
        floatingInfo.style.display = "block";
      } else {
        floatingInfo.style.display = "none";
      }
    });
  });

  window.addEventListener("beforeunload", function () {
    navigator.sendBeacon("/dashboard/log-disconnect");
  });
</script>
{% endblock %}
